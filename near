'use strict';

// --- CONFIGURATION & GLOBAL STATE ---
let riderCalculationCache = {};
let currentOrderId = null;

// Rider and list config
const CLEANING_RIDER_NAME = "Rider cleaning";
const CLEANING_RIDER_ID = "5fef37220b63c0111edee4b0"; 
const NUM_NEAR_RIDERS = 9; 
const DISPLAY_LIMIT = NUM_NEAR_RIDERS + 1; 
const ACTIVE_STATUSES = ['online', 'en_course'];

const REFRESH_BUTTON_TITLE = 'Actualiser';

// --- UTILITY FUNCTIONS ---

function calculateDistance(lat1, lon1, lat2, lon2) {
    // ... (rest of the calculateDistance function) ...
}

function getOrderInfoFromURL() {
    // ... (rest of the getOrderInfoFromURL function) ...
}

// --- API LOGIC (Assignment and Status Update) ---

async function makeRiderOnline(event, riderId) {
    // ... (rest of the makeRiderOnline function) ...
}

async function assignRiderToOrder(event, orderId, basePath) {
    // ... (rest of the assignRiderToOrder function) ...
}

// --- UI INJECTION & RENDERING ---
function injectRiderList(orderInfo, topRiders) {
    // ... (rest of the injectRiderList function) ...
}

// --- RIDER CALCULATION LOGIC ---
async function runRiderCalculation(orderInfo, forceRecalculation) {
    // ... (rest of the runRiderCalculation function) ...
}

// --- EXECUTION CONTROL ---

function mainRiderCheck(info, forceRecalculation = false) {
    
    const targetId = info.targetId;

    if (info.orderId !== currentOrderId) {
        currentOrderId = info.orderId;
        console.log(`Livry Rider Script: Detail Page Detected: ${currentOrderId}`);
        const oldElement = document.getElementById(targetId);
        if(oldElement) oldElement.innerHTML = '';
    }
    
    runRiderCalculation(info, forceRecalculation); 
    
    // --- 2. Ensure Persistence and Refresh Listener is attached/maintained ---
    attachAndMaintainListeners(info);
}

// Attaches and maintains the listener logic
let observer = null;
function attachAndMaintainListeners(info) {
    const targetId = info.targetId;

    if (observer) observer.disconnect();

    observer = new MutationObserver((mutationsList, obs) => {
        const targetElement = document.getElementById(targetId);
        const refreshButton = document.querySelector(`[title="${REFRESH_BUTTON_TITLE}"].MuiIconButton-root`);
        
        // A. Re-injection Logic (Persistence):
        if (targetElement && !targetElement.querySelector('.rider-list-injected')) {
            injectRiderList(info, riderCalculationCache[info.orderId] || []);
        }

        // B. Refresh Button Listener Logic:
        if (refreshButton && !refreshButton.listenerAttached) {
            refreshButton.listenerAttached = true; 
            refreshButton.addEventListener('click', () => {
                console.log(`\nðŸ”„ Refresh button clicked. Forcing recalculation for ID: ${info.orderId}`);
                delete riderCalculationCache[info.orderId];
                debouncedRun(true); 
            });
            console.log('Livry Rider Script: Attached click listener to "Actualiser" button.');
        }
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
}

// Debounced function to run the logic safely
const debouncedRun = (() => {
    let timeout;
    return (forceRecalculation = false) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const info = getOrderInfoFromURL();
            if (info) {
                mainRiderCheck(info, forceRecalculation);
            } else {
                currentOrderId = null;
            }
        }, 50); 
    };
})();

// --- INITIALIZATION ---

// Expose functions globally for inline HTML buttons
window.assignRiderToOrder = assignRiderToOrder;
window.makeRiderOnline = makeRiderOnline; 

// Listeners for SPA navigation and page load
window.addEventListener('hashchange', () => debouncedRun());
window.addEventListener('load', () => debouncedRun());

console.log("âœ… Rider Locator (External Script) is loaded.");
